Editor=function(){var t={},e=null,o=null;t.ShowTips=function(e,o){null==o&&(o=()=>{t.HideTips()}),$("#Main-Tips").off("click").text(e).click(o).show(),TipsActive=!0,t.ClearHighlights()},t.HideTips=function(){$("#Main-Tips").hide(),TipsActive=!1,t.ClearHighlights()},t.ShowErrors=function(e){t.ClearHighlights();var o=JSON.parse(e)[0];2147483647==o.start?t.ShowTips(o.message):n.push(new r("error",o).ShowAll())};var n=[],i=null;t.ClearHighlights=function(){for(var e=0;e<n.length;e++)n[e].Clear();t.ClearExplanation(),n=[]};var r=function(t,o){if(this.Type=t,this.Message=o.message,this.PositionFrom=o.from,this.PositionTo=o.to,null==this.PositionFrom||null==this.PositionTo)for(var n=e.lineCount(),i=0,r=0;r<n;r++){var l=e.getLine(r).length;if(null==this.PositionFrom&&o.start<=i+l&&(this.PositionFrom={line:r,ch:o.start-i}),null==this.PositionTo&&o.end<=i+l&&(this.PositionTo={line:r,ch:o.end-i}),null!=this.PositionFrom&&null!=this.PositionTo)break;i+=l+1}};r.prototype.Clear=function(){return null!=this.TextMarker&&this.TextMarker.clear(),null!=this.Gutter&&e.doc.setGutterMarker(this.PositionFrom.line,this.Type,null),null!=this.TipsWidget&&this.HideTips(),null},r.prototype.ScrollIntoView=function(t=200){return e.scrollIntoView(this.PositionFrom,t),this},r.prototype.MarkText=function(){return this.TextMarker=e.doc.markText(this.PositionFrom,this.PositionTo,{className:"cm-"+this.Type}),this},r.prototype.ShowTips=function(t){if(null==this.TipsWidget){var o=$("<div class='CodeMirror-context-tips'></div>");return-1!=this.Message.indexOf("<span")?o.html(this.Message):o.text(this.Message),o.click(null!=t?t:()=>this.HideTips()),this.TipsWidget=e.doc.addLineWidget(this.PositionFrom.line,o[0],{}),this}},r.prototype.HideTips=function(){if(null!=this.TipsWidget)return this.TipsWidget.clear(),this.TipsWidget=null,this},r.prototype.ShowGutter=function(){return this.Gutter=$("<div class='CodeMirror-marker-"+this.Type+"'></div>")[0],this.Gutter.Callback=()=>this.ShowTips(),e.doc.setGutterMarker(this.PositionFrom.line,this.Type,this.Gutter),this},r.prototype.ShowAll=function(t){return this.MarkText().ShowTips(t).ShowGutter().ScrollIntoView()},t.Explain=function(t=!0){Commands.Visible?Commands.Explain(t):a(t)},t.ExplainNotFound=function(){t.Toast("warning",Localized.Get("未能找到选中内容的相关信息。"))},t.ClearExplanation=function(){null!=i&&(i=i.Clear())};var l=0,a=function(o){if(clearTimeout(l),e.doc.somethingSelected()){for(var n=e.doc.listSelections()[0],a={from:n.anchor,to:n.head},s=a.from.line;s<=a.to.line;s++){var c=e.getLineTokens(s);for(var d of c)if(!(s==a.from.line&&d.end<a.from.ch||s==a.to.line&&d.start>a.to.ch||null==d.type)){if(null!=a.message&&!o)return;var u=`<span class="cm-${d.type}">${d.string}</span>`;a.command=d.string,Dictionary.Check(a.command)?a.message=`${u}: ${Dictionary.Get(a.command)} ➤`:Dictionary.Check("~"+d.type)&&(a.message=Dictionary.Get("~"+d.type).replace("{0}",u),a.command=null)}if(null!=a.message)break}if(null==a.message){if(!o)return;return t.ExplainNotFound()}t.ClearExplanation(),i=new r("help",a).ShowAll((()=>{null!=a.command&&Commands.Execute(null,`help ${a.command} -full`),t.ClearExplanation()}))}};return t.ClearDialogs=function(){return $(".CodeMirror-dialog").remove()},t.Toast=function(t,e,o){toastr[t](e,o)},t.Confirm=function(t,e,o,n){$.confirm({title:Localized.Get(t),content:Localized.Get(e),type:"green",useBootstrap:!1,buttons:{ok:{text:Localized.Get("确定"),btnClass:"btn-primary",keys:["enter"],action:o},cancel:{text:Localized.Get("取消"),action:n}}})},t.SetContent=function(o,n){e.off("changes"),o!=t.GetContent()&&(e.setValue(o),e.doc.clearHistory(),t.ClearHighlights()),n||t.SetApplied(),e.on("changes",(()=>t.Call({Type:"CodeChanged"})))},t.GetEditor=function(){return e},t.GetContent=function(o){return o&&(t.Blur(),Commands.Blur()),e.getValue()},t.SetApplied=function(){e.doc.changeGeneration(),t.HideTips()},t.SetReadonly=function(t){e.setOption("readOnly",t)},t.Blur=function(){e.getInputField().blur()},t.Undo=function(){e.getOption("readOnly")||e.doc.undo()},t.Redo=function(){e.getOption("readOnly")||e.doc.redo()},t.Find=function(){t.ClearDialogs(),e.execCommand("find")},t.Replace=function(){t.ClearDialogs(),e.execCommand("replace")},t.JumpTo=function(o){null!=o||(t.ClearDialogs(),e.execCommand("jumpToLine"))},t.JumpNetTango=function(){Commands.Hide();var o=t.GetContent().indexOf("; --- NETTANGO BEGIN ---");if(-1!=o){var n=e.doc.posFromIndex(o);e.scrollTo(0,e.getScrollInfo().height),e.scrollIntoView(n,0)}},t.SelectAll=function(){e.focus(),e.execCommand("selectAll")},t.Reset=function(){t.Confirm(Localized.Get("重置代码"),Localized.Get("是否将代码重置到最后一次成功编译的状态？"),(()=>t.Call({Type:"CodeReset"})))},t.ShowMenu=function(){var e=$("#Dialog-Procedures"),o=e.children("ul").empty();e.children("h4").text(Localized.Get("更多功能"));var n={};for(var i in n[Localized.Get("选择全部")]=t.SelectAll,n[Localized.Get("撤销操作")]=t.Undo,n[Localized.Get("重做操作")]=t.Redo,n[Localized.Get("跳转到行")]=t.JumpTo,n[Localized.Get("重置代码")]=t.Reset,n)$(`<li>${i}</li>`).attr("Tag",i).appendTo(o).click((function(){n[$(this).attr("Tag")](),$.modal.close()}));$("#Dialog-Procedures").modal({})},t.ShowProcedures=function(){var o=t.GetProcedures();if(0==Object.keys(o).length)t.Toast("warning",Localized.Get("代码中还没有任何子程序。"));else{var n=$("#Dialog-Procedures"),i=n.children("ul").empty();n.children("h4").text(Localized.Get("跳转到子程序"));var r=function(){var t=e.doc.posFromIndex($(this).attr("start")),o=e.doc.posFromIndex($(this).attr("end"));e.scrollIntoView(t,200),e.setSelection(t,o),$.modal.close()};for(var l in o)$(`<li>${l}</li>`).appendTo(i).attr("start",o[l][0]).attr("end",o[l][1]).click(r);$("#Dialog-Procedures").modal({})}},t.GetProcedures=function(){for(var e=/^\s*(?:to|to-report)\s(?:\s*;.*\n)*\s*(\w\S*)/gm,o=t.GetContent(),n=[];Match=e.exec(o);){var i=Match.index+Match[0].length;n[Match[1]]=[i-Match[1].length,i]}return n},t.Initialize=function(){t.Container=$("#Main-Editor"),o=new Darkmode,e=CodeMirror(document.getElementById("Main-CodeMirror"),{lineNumbers:!0,lineWrapping:!0,mode:"netlogo",theme:"netlogo-default",gutters:["error","CodeMirror-linenumbers"],matchBrackets:!0,autoCloseBrackets:!0}),CodeMirror.registerHelper("hintWords","netlogo",window.keywords.all.filter((t=>!window.keywords.unsupported.includes(t)))),CodeMirror.registerHelper("hint","fromList",((t,e)=>{var o=t.getCursor(),n=t.getTokenAt(o),i=CodeMirror.Pos(o.line,n.end);if(n.string&&/\S/.test(n.string[n.string.length-1])?(term=n.string.toLowerCase(),from=CodeMirror.Pos(o.line,n.start)):(term="",from=i),found=e.words.filter((t=>t.slice(0,term.length)==term)).map((t=>t.replace("\\?","?"))).sort(),found.length>0&&(1!=found.length||found[0]!=term))return{list:found,from,to:i}})),e.on("keyup",((t,e)=>{t.state.completionActive||e.ctrlKey||e.code.startsWith("Control")||(e.keyCode>64&&e.keyCode<91||186==e.keyCode||189==e.keyCode)&&t.showHint({completeSingle:!1,container:$("#Container").get(0)})})),e.on("gutterClick",((t,e)=>{var o=t.doc.getLineHandle(e);null!=o.gutterMarkers&&Object.keys(o.gutterMarkers).forEach((t=>{o.gutterMarkers[t].Callback()}))})),e.on("beforeSelectionChange",((e,o)=>{if(0!=o.ranges.length){var n=o.ranges[0];n.anchor.line==n.head.line&&n.anchor.ch!=n.head.ch?(clearTimeout(l),"double-tap"==o.origin?l=setTimeout((()=>t.Explain(!1)),1):"triple-tap"!=o.origin&&0==navigator.maxTouchPoints?l=setTimeout((()=>t.Explain(!1)),500):t.ClearExplanation()):t.ClearExplanation()}})),e.addKeyMap({"Cmd-X":"indentMore"}),Overlays.Initialize(),t.ClearDialogs(),t.MainEditor=e},t.Resize=function(t){$("body").addClass("Mobile"),$("#viewport").attr("content",`width=device-width,initial-scale=${t},maximum-scale=${t},minimum-scale=${t},user-scalable=no,viewport-fit=cover`)},t.SetFontsize=function(t){$("html").css("font-size",t+"px")},t.ToggleDark=function(t){t!=o.isActivated()&&o.toggle()},t.SetPlatform=function(t){$("body").addClass(t)},t.TransformLinks=function(e){e.find("a").each(((e,o)=>{var n=(o=$(o)).attr("href");o.attr("href","javascript:void(0);"),o.on("click",(function(){t.Call({Type:"Visit",Target:n})}))}))},t.Call=function(t){PostMessage(JSON.stringify(t))},t}(),Overlays=function(){var t={Initialize:function(){t.RotateScreen=$("#Rotate-Screen").asOverlay().click((()=>t.RotateScreen.Hide()))}};return t}(),Localized=function(){var t={Initialize:function(e){t.Data=e,Editor.GetEditor().options.phrases=e,$(".Localized").each(((e,o)=>$(o).text(t.Get($(o).text()))))},Get:function(e){return t.Data&&t.Data.hasOwnProperty(e)?t.Data[e]:e}};return t}(),Dictionary=function(){var t={Initialize:function(e){t.Data=e},Get:function(e){return t.Check(e.trim().toLowerCase())?t.Data[e]:e},Check:function(e){return t.Data&&t.Data.hasOwnProperty(e.trim().toLowerCase())}};return t}(),Commands=function(){var t={},e=null,o=null,n=null,i=[],r=[],l=0;Contents=[],t.Disabled=!1,t.Visible=!0,t.Show=function(){Editor.Container.css("display","none"),t.Container.css("display","block"),bodyScrollLock.clearAllBodyScrollLocks(),bodyScrollLock.disableBodyScroll(document.querySelector("div.command-output")),bodyScrollLock.disableBodyScroll(document.querySelector("div.command-fulltext")),e.refresh(),t.HideFullText(),t.Visible=!0,Editor.ClearDialogs()},t.Hide=function(){Editor.Container.css("display","block"),t.Container.css("display","none"),t.Visible=!1,bodyScrollLock.clearAllBodyScrollLocks(),bodyScrollLock.disableBodyScroll(document.querySelector(".CodeMirror-scroll"),{allowTouchMove:()=>!0}),Editor.MainEditor.refresh()},t.Blur=function(){e.getInputField().blur()},t.Initialize=function(){t.Container=$("#Command-Center"),o=$(".command-output"),n=$(".command-fulltext"),u(o.find(".keep code"),null,!0),c=o.children(".Keep").length,(e=CodeMirror(document.getElementById("Command-Input"),{mode:"netlogo",theme:"netlogo-default",scrollbarStyle:"null",viewportMargin:1/0,cursorHeight:.8,matchBrackets:!0,autoCloseBrackets:!0})).on("keyup",((t,o)=>{const n=o.code;if("Enter"!==n&&"ArrowUp"!==n&&"ArrowDown"!==n&&0==l){const t=e.getValue(),o=$("#Command-Objective").val();r=[o,t],l=0}t.state.completionActive||o.ctrlKey||n.startsWith("Control")||(o.keyCode>64&&o.keyCode<91||186==o.keyCode||189==o.keyCode)&&t.showHint({completeSingle:!1,container:$("#Container").get(0)})})),e.on("keydown",((o,n)=>{if("Enter"==n.key||"Enter"==n.code){const o=e.getValue().replace(/\n/gi,"");if(t.ClearInput(),!o||t.Disabled)return;const n=$("#Command-Objective").val();t.Disabled=!0,t.Execute(n,o),i.push([n,o]),l=0,r=[],e.closeHint()}})),e.on("keydown",((e,o)=>{if("ArrowUp"==o.key||"ArrowUp"==o.code){if(l>=i.length)return;l+=1;const e=i.length-l;t.SetContent(i[e][0],i[e][1])}})),e.on("keydown",((e,o)=>{if("ArrowDown"==o.key||"ArrowDown"==o.code){if(l<=1)return l=0,void(0==r.length?t.ClearInput():t.SetContent(r[0],r[1]));const e=i.length-l;t.SetContent(i[e][0],i[e][1]),l-=1}})),window.VisualViewport&&window.visualViewport.addEventListener("resize",(()=>{if(-1==navigator.userAgent.indexOf("Macintosh")&&-1==navigator.userAgent.indexOf("Mac OS X")){var e=window.visualViewport.height;$("#Container").css("height",`${e}px`)}else setTimeout((()=>$(".command-output, .command-fulltext").css("padding-top",`calc(0.5em + ${document.body.scrollHeight-window.visualViewport.height}px)`)),100);t.Visible&&$(".command-output").scrollTop(1e5)})),t.Show()};var a=null,s=1e3,c=-1,d=function(t){null==a?o.append(t):a.append(t)};t.OpenBatch=function(){a=$(document.createDocumentFragment())},t.CloseBatch=function(){if(null!=a){var e=a.children().length;if(e>s)a.children().slice(0,e-s).remove(),o.children().slice(c).remove();else{var n=o.children().length-c+e;n>s&&o.children().slice(c,n-s+c).remove()}o.append(a),a=null,t.ScrollToBottom()}},t.PrintInput=function(e,o,n){null==e?e=$("#Command-Objective").val():$("#Command-Objective").val(e);var i=$(`\n\t\t\t<div class="command-wrapper">\n\t\t\t\t<div class="content">\n\t\t\t\t\t<p class="input Code">${e}&gt;\n\t\t\t\t\t\t<span class="cm-s-netlogo-default"></span>\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t<div class="icon">\n\t\t\t\t\t<img class="copy-icon" src="images/copy.png"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);return n||d(i),i.attr("objective",e),i.attr("content",o),i.children(".icon").on("click",(()=>{t.SetContent(i.attr("objective"),i.attr("content")),Editor.Call({Type:"ClipboardWrite",Content:`${i.attr("objective")}: ${i.attr("content")}`})})),u(i.children(".content").children(".Code").children("span"),o),i},t.PrintOutput=function(e,n){switch(n){case"CompilationError":i=$(`\n\t\t\t\t\t<p class="CompilationError output">${Localized.Get("抱歉，未能理解你输入的命令")}: ${e}</p>\n\t\t\t\t`);break;case"RuntimeError":i=$(`\n\t\t\t\t\t<p class="RuntimeError output">${Localized.Get(e)}</p>\n\t\t\t\t`);break;case"Succeeded":i=$(`\n\t\t\t\t\t<p class="Succeeded output">${Localized.Get("成功执行了命令。")}</p>\n\t\t\t\t`);break;case"Output":o.children().last(),(i=$('<p class="Output output"></p>')).get(0).innerText=e;break;case"Help":var i=null;"string"==typeof e||e instanceof String?i=e.indexOf('<div class="block">')>=0?$(e):$(`\n\t\t\t\t\t\t\t<p class="${n} output">${e}</p>\n\t\t\t\t\t\t`):"array"==typeof e||e instanceof Array?i=$(`\n\t\t\t\t\t\t<div class="block">\n\t\t\t\t\t\t\t${e.map((t=>`<p class="${n} output">${t}</p>`)).join("")}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`):"-full"==e.Parameter?this.ShowFullText(e):i=$(`\n\t\t\t\t\t\t<div class="block">\n\t\t\t\t\t\t\t<p class="${n} output"><code>${e.display_name}</code> - ${e.agents.map((t=>`${m(t)}`)).join(", ")}</p>\n\t\t\t\t\t\t\t<p class="${n} output">${e.short_description} (<a class='command' target='help ${e.display_name} -full'">${Localized.Get("阅读全文")}</a>)</p>\n\t\t\t\t\t\t\t<p class="${n} output">${Localized.Get("参见")}: ${e.see_also.map((t=>`<a class='command' target='help ${t}'>${t}</a>`)).join(", ")}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`),null!=i&&(h(i.find("a.command")),p(i.find("div.command")),u(i.find("code")));break;default:i=$(`\n\t\t\t\t\t<p class="${n} output">${e}</p>\n\t\t\t\t`)}d(i),null==a&&t.ScrollToBottom()};var u=function(e,o,n){for(var i of e.get()){var r=$(i);r.addClass("cm-s-netlogo-default"),CodeMirror.runMode(o||i.innerText,"netlogo",i),n&&i.innerText.trim().indexOf(" ")>=0&&0==r.parent("pre").length&&r.addClass("copyable").append($('<img class="copy-icon" src="images/copy.png"/>')).on("click",(function(){t.SetContent("observer",this.innerText)}))}},p=function(e){e.each(((e,o)=>{(o=$(o)).replaceWith(t.PrintInput(o.attr("objective"),o.attr("target"),!0))}))},h=function(t){return t.each(((t,e)=>{var o=(e=$(e)).attr("target");null==o&&(o=e.text());var n=e.attr("objective");n||(n="null"),e.attr("href","javascript:void(0)"),e.attr("onclick",`Commands.Execute(${n}, '${o}')`)})),t},m=t=>{var e=t;switch(t){case"turtles":e=`${Localized.Get("海龟")}🐢`;break;case"patches":e=`${Localized.Get("格子")}🔲`;break;case"links":e=`${Localized.Get("链接")}🔗`;break;case"observer":e=`${Localized.Get("观察者")}🔎`;break;case"utilities":e=`${Localized.Get("工具")}🔨`}return e};t.ClearInput=function(){e.getDoc().setValue("")},t.ClearOutput=function(){o.children().slice(c).remove()},t.ScrollToBottom=function(){const t=document.querySelector(".command-output").scrollHeight;document.querySelector(".command-output").scrollTop=t},t.Execute=function(e,o){Editor.Call({Type:"CommandExecute",Source:e,Command:o}),t.PrintInput(e,o),t.ScrollToBottom()},t.SetContent=function(t,o){document.querySelector("select").value=t.toLowerCase(),e.getDoc().setValue(o),e.focus(),setTimeout((()=>e.setCursor(o.length)),1)},t.FinishExecution=function(e,o){t.HideFullText(),t.PrintOutput(o,e),t.Disabled=!1};var f=!1;t.ShowFullText=function(e){f=t.Visible,t.Visible||t.Show(),n.show(),o.hide(),$(n.find("h2 strong")).text(e.display_name),$(n.find("h2 span")).text(`(${e.agents.map((t=>`${m(t)}`)).join(", ")})`);var i=n.find("ul.SeeAlso").empty();for(var r in e.see_also)h($(`<li><a class="command" target="help ${r}">${r}</a> - ${e.see_also[r]}</li>`).appendTo(i).find("a"));var l=n.find(".translator");null!=e.translation&&1!=e.verified?l.show():l.hide();var a=l.find("a.Original").bind("click",(()=>{a.hide(),s.show(),c(e.content)})).parent().show(),s=l.find("a.Translation").bind("click",(()=>{s.hide(),a.show(),c(e.translation)})).parent().hide(),c=t=>{null!=t&&n.find("div.fulltext").html((new showdown.Converter).makeHtml(t)),u(n.find("code"),null,!0),n.get(0).scrollTop=0};c(null!=e.translation?e.translation:e.content),Editor.TransformLinks(n.find(".Acknowledge").html(e.acknowledge))},t.HideFullText=function(e){n.hide(),o.show(),t.ScrollToBottom(),e&&!f&&t.Hide()},t.Explain=function(){var t=window.getSelection();if(0!=t.rangeCount){var e=$(window.getSelection().focusNode).parents();e.is(".command-output")&&(g(t.toString())||(e.hasClass("cm-command")||e.hasClass("cm-reporter")||e.hasClass("cm-keyword"))&&g(e.get(0).innerText))}};var g=function(e){if(!Dictionary.Check(e))return!1;t.ScrollToBottom(),t.Execute(null,`ask ${e} -full`)};return t}(),jQuery.fn.asOverlay=function(t=3e3,e=300){return this.Hide=()=>this.fadeOut(e),this.Show=()=>{clearTimeout(this.timeout),this.timeout=setTimeout((()=>this.fadeOut(e)),t),this.fadeIn(e)},this};